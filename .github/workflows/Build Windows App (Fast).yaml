name: Build Windows App (Fast)

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'simple_live_app/**'
      - '.github/workflows/**'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 1

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          # 开启 pub cache，加速 pub get
          cache-key: 'flutter-pub-windows-${{ hashFiles('simple_live_app/pubspec.lock') }}'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      - name: Enable Flutter Desktop
        run: flutter config --enable-windows-desktop

      # 优化：显式缓存 Pub 依赖 (如果 subosito action 的缓存不够用)
      - name: Cache Pub Packages
        uses: actions/cache@v3
        with:
          path: |
            ~\AppData\Local\Pub\Cache
          key: ${{ runner.os }}-pub-${{ hashFiles('simple_live_app/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Restore Packages
        run: |
          cd simple_live_app
          flutter pub get

      # 注入防止警告的代码 (保持原样)
      - name: Suppress C++ Build Warnings
        shell: powershell
        run: |
          $cmakePath = "simple_live_app/windows/CMakeLists.txt"
          $flagsToSuppress = " /wd4244 /wd4458"
          if (Test-Path $cmakePath) {
              $content = Get-Content $cmakePath
              $pattern = "set\(MSVC_WARNING_OPTIONS"
              if ($content -match $pattern) {
                  $replacement = "$pattern $flagsToSuppress"
                  $content -replace $pattern, $replacement | Set-Content $cmakePath
                  echo "✅ Successfully injected warning suppression flags."
              }
          }

      # 优化核心：直接构建，不安装 distributor
      - name: Build Windows Release
        run: |
          cd simple_live_app
          flutter build windows --release

      # 优化核心：手动打包 Zip (替代 distributor)
      - name: Package Windows Zip
        shell: powershell
        run: |
          cd simple_live_app
          $buildDir = "build\windows\x64\runner\Release"
          $zipName = "simple_live_app_windows.zip"
          
          # 检查构建是否成功
          if (-Not (Test-Path "$buildDir\simple_live_app.exe")) {
             Write-Error "Build artifact not found!"
             exit 1
          }

          echo "Compressing build artifacts..."
          # 将 Release 文件夹下的所有内容压缩
          Compress-Archive -Path "$buildDir\*" -DestinationPath "build\$zipName" -Force
          
          echo "✅ Package created at build\$zipName"

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-zip
          path: simple_live_app/build/*.zip
