name: Build Windows App (Master)

on:
  # 允许手动触发
  workflow_dispatch:
  # 监听 master 分支的推送
  push:
    branches:
      - master
    paths:
      - 'simple_live_app/**'
      - '.github/workflows/**'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      # 1. 签出代码 (切换到 master 分支)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 1

      # 2. 设置 Flutter 环境 (使用 stable 渠道)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # 3. 开启 Windows 桌面端支持
      - name: Enable Flutter Desktop
        run: flutter config --enable-windows-desktop

      # 4. 拉取依赖
      - name: Restore Packages
        run: |
          cd simple_live_app
          flutter pub get

      # 5. [新增] 屏蔽 C++ 编译警告 (C4244, C4458)
      # 这步必须在 flutter pub get 之后，Build 之前运行
      - name: Suppress C++ Build Warnings
        shell: powershell
        run: |
          $cmakePath = "simple_live_app/windows/CMakeLists.txt"
          $flagsToSuppress = " /wd4244 /wd4458"
          
          if (Test-Path $cmakePath) {
              $content = Get-Content $cmakePath
              $pattern = "set\(MSVC_WARNING_OPTIONS"
              
              if ($content -match $pattern) {
                  $replacement = "$pattern $flagsToSuppress"
                  $content -replace $pattern, $replacement | Set-Content $cmakePath
                  echo "✅ Successfully injected warning suppression flags."
              } else {
                  echo "⚠️ Warning: MSVC_WARNING_OPTIONS not found."
              }
          } else {
              echo "❌ Error: CMakeLists.txt not found at $cmakePath"
              exit 1
          }

      # 6. 安装打包工具
      - name: Install flutter_distributor
        run: dart pub global activate flutter_distributor

      # 7. 执行 Windows 编译 (只打 zip 包)
      - name: Build Windows
        run: |
          cd simple_live_app
          # 去掉了 msix，只保留 zip
          flutter_distributor package --platform windows --targets zip --skip-clean

      # 8. 查看构建产物 (使用 PowerShell 语法)
      - name: Show build output
        run: |
          cd simple_live_app
          echo "======= Windows build output ======="
          if (Test-Path "build/dist") {
              Get-ChildItem -Path "build/dist" -Recurse
          } else {
              echo "❌ Build directory not found!"
          }

      # 9. 上传产物
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-zip
          path: |
            simple_live_app/build/dist/**/*.zip
            simple_live_app/build/dist/**/*.exe
